# =============================================================================
# Infrastructure CI Pipeline
# =============================================================================
# crac-ci 중앙 저장소의 Reusable Workflows를 사용하여 검증합니다.
#
# 검증 항목:
#   1. Helm 차트 lint 및 템플릿 렌더링
#   2. Kind 클러스터 설정 유효성
#   3. ArgoCD 매니페스트 검증
# =============================================================================

name: Infrastructure CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # ---------------------------------------------------------------------------
  # Helm 차트 검증
  # ---------------------------------------------------------------------------
  helm-validate:
    name: Validate Helm Charts
    uses: flex-junehyukhong/crac-ci/.github/workflows/helm-validate.yaml@main
    with:
      chart-path: './helm-charts/sample-app'
      kube-version: '1.29.0'
      strict: false
      upload-manifests: true

  # ---------------------------------------------------------------------------
  # Kind 클러스터 설정 검증
  # ---------------------------------------------------------------------------
  kind-validate:
    name: Validate Kind Config
    uses: flex-junehyukhong/crac-ci/.github/workflows/kind-validate.yaml@main
    with:
      config-path: './kind/kind-config.yaml'
      kind-version: '0.22.0'
      validate-schema: true
      check-node-config: true

  # ---------------------------------------------------------------------------
  # ArgoCD 매니페스트 검증
  # ---------------------------------------------------------------------------
  argocd-validate:
    name: Validate ArgoCD Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate YAML Syntax
        run: |
          echo "Validating ArgoCD manifests..."
          ERROR_COUNT=0

          for file in argocd/*.yaml argocd/**/*.yaml; do
            if [[ -f "$file" ]]; then
              echo "Checking: $file"
              if ! yq eval '.' "$file" > /dev/null 2>&1; then
                echo "::error::Invalid YAML: $file"
                ((ERROR_COUNT++))
              fi
            fi
          done

          if [[ $ERROR_COUNT -gt 0 ]]; then
            echo "::error::Found $ERROR_COUNT invalid YAML files"
            exit 1
          fi
          echo "All ArgoCD manifests are valid YAML"

      - name: Validate ArgoCD Application Structure
        run: |
          echo "Checking ArgoCD Application resources..."

          for file in argocd/applications/*.yaml; do
            if [[ -f "$file" ]]; then
              echo "Validating: $file"

              KIND=$(yq eval '.kind' "$file")
              API_VERSION=$(yq eval '.apiVersion' "$file")

              if [[ "$KIND" != "Application" && "$KIND" != "AppProject" ]]; then
                echo "::warning::$file has kind '$KIND', expected 'Application' or 'AppProject'"
              fi

              if [[ ! "$API_VERSION" =~ ^argoproj.io/ ]]; then
                echo "::warning::$file has unexpected apiVersion: $API_VERSION"
              fi

              # Check required fields for Application
              if [[ "$KIND" == "Application" ]]; then
                DEST_SERVER=$(yq eval '.spec.destination.server // ""' "$file")
                SOURCE_REPO=$(yq eval '.spec.source.repoURL // ""' "$file")

                if [[ -z "$DEST_SERVER" ]]; then
                  echo "::error::$file missing spec.destination.server"
                fi
                if [[ -z "$SOURCE_REPO" ]]; then
                  echo "::error::$file missing spec.source.repoURL"
                fi
              fi
            fi
          done

      - name: Summary
        run: |
          echo "## ArgoCD Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All ArgoCD manifests validated successfully." >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # 전체 검증 완료 확인
  # ---------------------------------------------------------------------------
  validation-complete:
    name: All Validations Passed
    needs: [helm-validate, kind-validate, argocd-validate]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check Results
        run: |
          if [[ "${{ needs.helm-validate.result }}" != "success" ]] || \
             [[ "${{ needs.kind-validate.result }}" != "success" ]] || \
             [[ "${{ needs.argocd-validate.result }}" != "success" ]]; then
            echo "::error::One or more validations failed"
            exit 1
          fi

      - name: Summary
        run: |
          echo "## Infrastructure Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Helm Charts | ${{ needs.helm-validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kind Config | ${{ needs.kind-validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ArgoCD Manifests | ${{ needs.argocd-validate.result }} |" >> $GITHUB_STEP_SUMMARY
