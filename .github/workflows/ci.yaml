# =============================================================================
# GitHub Actions CI 파이프라인
# =============================================================================
# 이 워크플로우는 코드 변경 시 자동으로 실행되어 Helm 차트와 Kind 설정을 검증합니다.
# 주요 검증 항목:
#   1. Helm 차트 문법 검사 (lint)
#   2. Kind 클러스터 설정 유효성 검사
#   3. Kubernetes 매니페스트 렌더링 테스트
# =============================================================================

name: CI

# -----------------------------------------------------------------------------
# 트리거 조건 설정
# -----------------------------------------------------------------------------
# push: main 또는 master 브랜치에 직접 푸시될 때 실행
# pull_request: main 또는 master 브랜치로의 PR이 생성/업데이트될 때 실행
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  validate:
    # -------------------------------------------------------------------------
    # 실행 환경: Ubuntu 최신 버전의 GitHub 호스팅 러너 사용
    # -------------------------------------------------------------------------
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------------
      # Step 1: 소스 코드 체크아웃
      # -----------------------------------------------------------------------
      # actions/checkout@v4: 저장소의 코드를 러너에 복제
      # 이후 단계에서 코드에 접근할 수 있도록 함
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Step 2: Helm CLI 설치
      # -----------------------------------------------------------------------
      # azure/setup-helm@v3: Helm CLI를 설치하는 공식 액션
      # version: 'latest'로 설정하여 항상 최신 버전 사용
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      # -----------------------------------------------------------------------
      # Step 3: Helm 차트 문법 검사
      # -----------------------------------------------------------------------
      # helm lint: 차트의 문법 오류, 필수 파일 누락, 베스트 프랙티스 위반 검사
      # 오류 발생 시 워크플로우가 실패하여 잘못된 차트 배포 방지
      - name: Lint Helm Chart
        run: helm lint helm-charts/sample-app

      # -----------------------------------------------------------------------
      # Step 4: Kind 클러스터 설정 검증
      # -----------------------------------------------------------------------
      # Kind가 설치되어 있지 않으면 다운로드하여 설치
      # kind-config.yaml로 테스트 클러스터 생성 시도 후 즉시 삭제
      # 설정 파일의 문법 오류나 잘못된 옵션을 검출
      - name: Validate Kind Config
        run: |
          if ! command -v kind &> /dev/null; then
            curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
            chmod +x ./kind
            sudo mv ./kind /usr/local/bin/kind
          fi
          kind create cluster --config kind/kind-config.yaml --name ci-test || true
          kind delete cluster --name ci-test

      # -----------------------------------------------------------------------
      # Step 5: Kubernetes 매니페스트 렌더링 검증
      # -----------------------------------------------------------------------
      # helm template: values.yaml을 적용하여 최종 K8s 매니페스트 생성
      # 템플릿 문법 오류, 잘못된 변수 참조 등을 검출
      # 실제 클러스터 없이도 매니페스트 유효성 확인 가능
      - name: Validate Kubernetes Manifests
        run: |
          helm template sample-app helm-charts/sample-app > /tmp/rendered.yaml
          echo "Helm template rendered successfully"
