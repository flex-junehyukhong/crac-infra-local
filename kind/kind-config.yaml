# =============================================================================
# Kind (Kubernetes IN Docker) 클러스터 설정
# =============================================================================
# Kind는 Docker 컨테이너를 사용하여 로컬에서 Kubernetes 클러스터를 실행합니다.
# 이 설정은 1개의 control-plane과 2개의 worker 노드로 구성된 클러스터를 정의합니다.
#
# 클러스터 구조:
#   - crac-local-control-plane (control-plane): API 서버, 스케줄러, 컨트롤러 매니저
#   - crac-local-worker (worker): 워크로드 실행
#   - crac-local-worker2 (worker): 워크로드 실행
# =============================================================================

# Kind 리소스 타입 지정
kind: Cluster

# Kind API 버전 (v1alpha4가 현재 최신 안정 버전)
apiVersion: kind.x-k8s.io/v1alpha4

# 클러스터 이름: kubectl context에서 "kind-crac-local"로 표시됨
name: crac-local

# -----------------------------------------------------------------------------
# 노드 구성
# -----------------------------------------------------------------------------
nodes:
  # ---------------------------------------------------------------------------
  # Control Plane 노드
  # ---------------------------------------------------------------------------
  # Kubernetes 컨트롤 플레인 컴포넌트를 실행하는 마스터 노드
  # - kube-apiserver: 모든 API 요청 처리
  # - kube-scheduler: Pod를 적절한 노드에 스케줄링
  # - kube-controller-manager: 클러스터 상태 관리
  # - etcd: 클러스터 데이터 저장소
  - role: control-plane

    # -------------------------------------------------------------------------
    # kubeadm 설정 패치
    # -------------------------------------------------------------------------
    # kubeadm으로 클러스터 초기화 시 적용되는 추가 설정
    kubeadmConfigPatches:
      - |
        kind: InitConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            # ingress-ready=true 라벨 추가
            # Ingress Controller가 이 노드에서 실행될 수 있음을 표시
            # NodePort 서비스가 이 노드를 통해 외부에 노출됨
            node-labels: "ingress-ready=true"

    # -------------------------------------------------------------------------
    # 포트 매핑 설정
    # -------------------------------------------------------------------------
    # Docker 컨테이너 포트를 호스트 머신 포트에 매핑
    # 이를 통해 localhost에서 클러스터 내부 서비스에 접근 가능
    extraPortMappings:
      # ArgoCD UI 접근용 포트
      # https://localhost:30080 → ArgoCD 서버 (NodePort 30080)
      - containerPort: 30080
        hostPort: 30080
        protocol: TCP

      # Sample App 접근용 포트
      # http://localhost:30000 → nginx 애플리케이션 (NodePort 30000)
      - containerPort: 30000
        hostPort: 30000
        protocol: TCP

      # flex-skeleton 접근용 포트
      # http://localhost:30001 → flex-skeleton API (NodePort 30001)
      - containerPort: 30001
        hostPort: 30001
        protocol: TCP

  # ---------------------------------------------------------------------------
  # Worker 노드 1
  # ---------------------------------------------------------------------------
  # 실제 애플리케이션 Pod가 스케줄링되어 실행되는 노드
  # control-plane의 부하를 분산하고 워크로드 격리 제공
  - role: worker

  # ---------------------------------------------------------------------------
  # Worker 노드 2
  # ---------------------------------------------------------------------------
  # 추가 worker 노드로 고가용성 및 부하 분산 지원
  # Pod 복제본이 여러 노드에 분산 배치될 수 있음
  - role: worker
