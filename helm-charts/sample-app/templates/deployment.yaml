# =============================================================================
# Kubernetes Deployment 템플릿
# =============================================================================
# Deployment는 Pod의 선언적 배포와 업데이트를 관리하는 리소스입니다.
# ReplicaSet을 통해 지정된 수의 Pod 복제본이 항상 실행되도록 보장합니다.
#
# 주요 기능:
#   - 롤링 업데이트: 무중단 배포
#   - 롤백: 이전 버전으로 되돌리기
#   - 스케일링: 복제본 수 조절
#   - 자가 치유: 장애 Pod 자동 재시작
#
# Helm 템플릿 문법:
#   .Values.xxx - values.yaml의 값 참조
#   include "name" . - _helpers.tpl의 템플릿 함수 호출
#   대시(-) 접두사 - 앞쪽 공백 제거
#   | nindent N - 결과를 N칸 들여쓰기
# =============================================================================

# Kubernetes API 버전 (apps/v1은 Deployment의 안정 버전)
apiVersion: apps/v1

# 리소스 종류
kind: Deployment

# -----------------------------------------------------------------------------
# 메타데이터
# -----------------------------------------------------------------------------
metadata:
  # Deployment 이름: _helpers.tpl의 fullname 템플릿 사용
  # 릴리스명-차트명 형태로 생성됨 (예: sample-app-sample-app)
  name: {{ include "sample-app.fullname" . }}

  # 레이블: 리소스 식별 및 그룹화에 사용
  # _helpers.tpl의 labels 템플릿으로 표준 레이블 생성
  labels:
    {{- include "sample-app.labels" . | nindent 4 }}

# -----------------------------------------------------------------------------
# Deployment 스펙
# -----------------------------------------------------------------------------
spec:
  # ---------------------------------------------------------------------------
  # 레플리카 수
  # ---------------------------------------------------------------------------
  # 실행할 Pod 복제본 수 (values.yaml의 replicaCount 참조)
  replicas: {{ .Values.replicaCount }}

  # ---------------------------------------------------------------------------
  # 셀렉터
  # ---------------------------------------------------------------------------
  # 이 Deployment가 관리할 Pod를 선택하는 레이블 셀렉터
  # Pod 템플릿의 레이블과 반드시 일치해야 함
  selector:
    matchLabels:
      {{- include "sample-app.selectorLabels" . | nindent 6 }}

  # ---------------------------------------------------------------------------
  # Pod 템플릿
  # ---------------------------------------------------------------------------
  # 생성될 Pod의 명세
  template:
    metadata:
      # Pod에 부여할 레이블 (셀렉터와 일치해야 함)
      labels:
        {{- include "sample-app.selectorLabels" . | nindent 8 }}

    spec:
      # -----------------------------------------------------------------------
      # 컨테이너 정의
      # -----------------------------------------------------------------------
      containers:
          # 컨테이너 이름: Chart.yaml의 차트명 사용
        - name: {{ .Chart.Name }}

          # 컨테이너 이미지: values.yaml의 image 설정 조합
          # 형태: repository:tag (예: nginx:alpine)
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"

          # 이미지 Pull 정책
          imagePullPolicy: {{ .Values.image.pullPolicy }}

          # -----------------------------------------------------------------
          # 컨테이너 포트
          # -----------------------------------------------------------------
          # 컨테이너가 노출하는 포트 목록
          ports:
              # 포트 이름: Service에서 targetPort로 참조 가능
            - name: http
              # nginx 기본 포트
              containerPort: 80
              protocol: TCP

          # -----------------------------------------------------------------
          # Liveness Probe (생존 검사)
          # -----------------------------------------------------------------
          # 컨테이너가 살아있는지 확인
          # 실패 시 컨테이너 재시작
          # 애플리케이션 데드락이나 무한 루프 감지
          livenessProbe:
            httpGet:
              path: /
              port: http

          # -----------------------------------------------------------------
          # Readiness Probe (준비 검사)
          # -----------------------------------------------------------------
          # 컨테이너가 트래픽을 받을 준비가 되었는지 확인
          # 실패 시 Service 엔드포인트에서 제외 (트래픽 차단)
          # 애플리케이션 초기화 완료 여부 확인
          readinessProbe:
            httpGet:
              path: /
              port: http

          # -----------------------------------------------------------------
          # 리소스 제한
          # -----------------------------------------------------------------
          # values.yaml의 resources 설정을 YAML로 변환하여 삽입
          # toYaml: Go 객체를 YAML 문자열로 변환
          # nindent 12: 12칸 들여쓰기 적용
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
