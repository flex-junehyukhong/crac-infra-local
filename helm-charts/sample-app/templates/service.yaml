# =============================================================================
# Kubernetes Service 템플릿
# =============================================================================
# Service는 Pod 집합에 대한 안정적인 네트워크 엔드포인트를 제공합니다.
# Pod는 생성/삭제 시마다 IP가 변경되지만, Service는 고정 IP/DNS를 제공합니다.
#
# Service 타입:
#   - ClusterIP: 클러스터 내부 통신용 (기본값)
#   - NodePort: 각 노드의 고정 포트로 외부 노출
#   - LoadBalancer: 클라우드 LB 프로비저닝
#   - ExternalName: 외부 DNS를 클러스터 내부 이름으로 매핑
#
# 트래픽 흐름 (NodePort):
#   외부 요청 → localhost:30000 → Kind 노드:30000 → Service → Pod:80
# =============================================================================

# Kubernetes 핵심 API 버전
apiVersion: v1

# 리소스 종류
kind: Service

# -----------------------------------------------------------------------------
# 메타데이터
# -----------------------------------------------------------------------------
metadata:
  # Service 이름: Pod에서 이 이름으로 DNS 조회 가능
  # 예: sample-app.sample.svc.cluster.local
  name: {{ include "sample-app.fullname" . }}

  # 레이블: 리소스 관리 및 그룹화용
  labels:
    {{- include "sample-app.labels" . | nindent 4 }}

# -----------------------------------------------------------------------------
# Service 스펙
# -----------------------------------------------------------------------------
spec:
  # ---------------------------------------------------------------------------
  # 서비스 타입
  # ---------------------------------------------------------------------------
  # values.yaml의 service.type 참조
  # NodePort: 클러스터 외부에서 노드IP:nodePort로 접근 가능
  type: {{ .Values.service.type }}

  # ---------------------------------------------------------------------------
  # 포트 설정
  # ---------------------------------------------------------------------------
  ports:
      # Service 포트 (클러스터 내부에서 사용)
      # 다른 Pod에서 이 포트로 요청
    - port: {{ .Values.service.port }}

      # 대상 포트: Pod 컨테이너의 포트
      # 이름(http) 또는 숫자(80) 지정 가능
      # Deployment의 containerPort name과 일치
      targetPort: http

      # 프로토콜 (TCP/UDP/SCTP)
      protocol: TCP

      # 포트 이름: 여러 포트 정의 시 구분용
      name: http

      # NodePort 번호 (서비스 타입이 NodePort/LoadBalancer일 때)
      # 30000-32767 범위에서 지정
      # Kind의 extraPortMappings와 일치해야 localhost에서 접근 가능
      nodePort: {{ .Values.service.nodePort }}

  # ---------------------------------------------------------------------------
  # 셀렉터
  # ---------------------------------------------------------------------------
  # 트래픽을 전달할 Pod를 선택하는 레이블 셀렉터
  # 이 레이블을 가진 모든 Pod에 트래픽 분산 (라운드 로빈)
  # Deployment의 Pod 템플릿 레이블과 일치해야 함
  selector:
    {{- include "sample-app.selectorLabels" . | nindent 4 }}
